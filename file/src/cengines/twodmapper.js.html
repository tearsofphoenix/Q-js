<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/cengines/twodmapper.js | projectq</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#backends">backends</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/printer.js~CommandPrinter.html">CommandPrinter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/resource.js~ResourceCounter.html">ResourceCounter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#backends-circuits">backends/circuits</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/circuits/drawer.js~CircuitDrawer.html">CircuitDrawer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/circuits/drawer.js~CircuitItem.html">CircuitItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/circuits/tolatex.js~_Circ2Tikz.html">_Circ2Tikz</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_exports">_exports</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#backends-ibm">backends/ibm</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/ibm/ibm.js~IBMBackend.html">IBMBackend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/ibm/ibmhttpclient.js~IBMHTTPClient.html">IBMHTTPClient</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#backends-simulators">backends/simulators</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/simulators/classicalsimulator.js~ClassicalSimulator.html">ClassicalSimulator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/simulators/jssim.js~Simulator.html">Simulator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/simulators/shared.spec.js~TrivialMapper.html">TrivialMapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backends/simulators/simulator.js~Simulator.html">Simulator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-All">All</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#cengines">cengines</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/basicmapper.js~BasicMapperEngine.html">BasicMapperEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/basics.js~BasicEngine.html">BasicEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/basics.js~ForwarderEngine.html">ForwarderEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/cmdmodifier.js~CommandModifier.html">CommandModifier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/ibm5qubitmapper.js~IBM5QubitMapper.html">IBM5QubitMapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/linearmapper.js~LinearMapper.html">LinearMapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/main.js~MainEngine.html">MainEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/manualmapper.js~ManualMapper.html">ManualMapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/optimize.js~LocalOptimizer.html">LocalOptimizer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/swapandcnotflipper.js~SwapAndCNOTFlipper.html">SwapAndCNOTFlipper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/tagremover.js~TagRemover.html">TagRemover</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/testengine.js~CompareEngine.html">CompareEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/testengine.js~DummyEngine.html">DummyEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/twodmapper.js~GridMapper.html">GridMapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-return_swap_depth">return_swap_depth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ibmqx4_connections">ibmqx4_connections</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#cengines-replacer">cengines/replacer</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/replacer/decompositionrule.js~DecompositionRule.html">DecompositionRule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/replacer/decompositionruleset.js~DecompositionRuleSet.html">DecompositionRuleSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/replacer/replacer.js~AutoReplacer.html">AutoReplacer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cengines/replacer/replacer.js~InstructionFilter.html">InstructionFilter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#libs">libs</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-arrayEqual">arrayEqual</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-arrayFromRange">arrayFromRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-complexVectorDot">complexVectorDot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-expmod">expmod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-intersection">intersection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isComplex">isComplex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNumeric">isNumeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-len">len</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-narray">narray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-productLoop">productLoop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-productLoop3">productLoop3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-randomSample">randomSample</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setDifference">setDifference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setEqual">setEqual</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setFromRange">setFromRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setIsSuperSet">setIsSuperSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringToBitArray">stringToBitArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-symmetricDifference">symmetricDifference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unionSet">unionSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ObjectCopy">ObjectCopy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-arrayIsTuple">arrayIsTuple</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-classHierachy">classHierachy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-genString">genString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-instanceOf">instanceOf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isKindclassOf">isKindclassOf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isSubclassOf">isSubclassOf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-markTuple">markTuple</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matrixDot">matrixDot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matrixGetRow">matrixGetRow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matrixRangeAssign">matrixRangeAssign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matrixRangeIndicesAssign">matrixRangeIndicesAssign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tuple">tuple</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-zeros">zeros</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#libs-math">libs/math</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/libs/math/gates.js~AddConstant.html">AddConstant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/libs/math/gates.js~AddConstantModN.html">AddConstantModN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/libs/math/gates.js~MultiplyByConstantModN.html">MultiplyByConstantModN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add_constant">add_constant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add_constant_modN">add_constant_modN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mul_by_constant_modN">mul_by_constant_modN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SubConstant">SubConstant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SubConstantModN">SubConstantModN</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#meta">meta</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/compute.js~ComputeEngine.html">ComputeEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/compute.js~UncomputeEngine.html">UncomputeEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/control.js~ControlEngine.html">ControlEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/dagger.js~DaggerEngine.html">DaggerEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/error.js~LastEngineError.html">LastEngineError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/error.js~NoGateDecompositionError.html">NoGateDecompositionError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/error.js~NotMergeable.html">NotMergeable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/error.js~NotYetMeasuredError.html">NotYetMeasuredError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/error.js~QubitManagementError.html">QubitManagementError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/loop.js~LoopEngine.html">LoopEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/loop.js~LoopTag.html">LoopTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/tag.js~ComputeTag.html">ComputeTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/tag.js~DirtyQubitTag.html">DirtyQubitTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/tag.js~LogicalQubitIDTag.html">LogicalQubitIDTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meta/tag.js~UncomputeTag.html">UncomputeTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Compute">Compute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CustomUncompute">CustomUncompute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Uncompute">Uncompute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Control">Control</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Dagger">Dagger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Loop">Loop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dropEngineAfter">dropEngineAfter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertEngine">insertEngine</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ops">ops</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~BasicGate.html">BasicGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~BasicMathGate.html">BasicMathGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~BasicPhaseGate.html">BasicPhaseGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~BasicRotationGate.html">BasicRotationGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~ClassicalInstructionGate.html">ClassicalInstructionGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~FastForwardingGate.html">FastForwardingGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/basics.js~SelfInverseGate.html">SelfInverseGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~AllocateDirtyQubitGate.html">AllocateDirtyQubitGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~AllocateQubitGate.html">AllocateQubitGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~BarrierGate.html">BarrierGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~DeallocateQubitGate.html">DeallocateQubitGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~EntangleGate.html">EntangleGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~FlushGate.html">FlushGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~HGate.html">HGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~MeasureGate.html">MeasureGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~Ph.html">Ph</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~R.html">R</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~Rx.html">Rx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~Ry.html">Ry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~Rz.html">Rz</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~SGate.html">SGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~SqrtSwapGate.html">SqrtSwapGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~SqrtXGate.html">SqrtXGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~SwapGate.html">SwapGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~TGate.html">TGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~XGate.html">XGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~YGate.html">YGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/gates.js~ZGate.html">ZGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/metagates.js~ControlledGate.html">ControlledGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/metagates.js~DaggeredGate.html">DaggeredGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/metagates.js~Tensor.html">Tensor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/qftgate.js~QFTGate.html">QFTGate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/qubitoperator.js~QubitOperator.html">QubitOperator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ops/timeevolution.js~TimeEvolution.html">TimeEvolution</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add">add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInverse">getInverse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-C">C</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringToArray">stringToArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CRz">CRz</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Allocate">Allocate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AllocateDirty">AllocateDirty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Entangle">Entangle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-H">H</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Measure">Measure</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NOT">NOT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-S">S</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SqrtSwap">SqrtSwap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SqrtX">SqrtX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Swap">Swap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-T">T</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-X">X</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Y">Y</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Z">Z</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-obj">obj</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-All">All</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-QFT">QFT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PAULI_OPERATOR_PRODUCTS">PAULI_OPERATOR_PRODUCTS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CNOT">CNOT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CX">CX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CZ">CZ</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toffoli">Toffoli</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#setups">setups</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEngineList">getEngineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-high_level_gates">high_level_gates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEngineList">getEngineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEngineList">getEngineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEngineList">getEngineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEngineList">getEngineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEngineList">getEngineList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ibmqx5_connections">ibmqx5_connections</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#setups-decompositions">setups/decompositions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_find_parameters">_find_parameters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_arb1qubit">_recognize_arb1qubit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-phase">phase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_test_matrices">create_test_matrices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_decompose_barrier">_decompose_barrier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_barrier">_recognize_barrier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_carb1qubit">_recognize_carb1qubit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_v">_recognize_v</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_cnot">_recognize_cnot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_decompose_CnU">_decompose_CnU</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_CnU">_recognize_CnU</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_RxNoCtrl">_recognize_RxNoCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_decompose_ry">_decompose_ry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_recognize_RyNoCtrl">_recognize_RyNoCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rule_commuting_terms">rule_commuting_terms</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rule_individual_terms">rule_individual_terms</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#types">types</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/types/qubit.js~BasicQubit.html">BasicQubit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/types/qubit.js~Qubit.html">Qubit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Qureg">Qureg</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/cengines/twodmapper.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/*
Mapper for a quantum circuit to a 2D square grid.

    Input: Quantum circuit with 1 and 2 qubit gates on n qubits. Gates are assumed
to be applied in parallel if they act on disjoint qubit(s) and any pair
of qubits can perform a 2 qubit gate (all-to-all connectivity)
Output: Quantum circuit in which qubits are placed in 2-D square grid in which
only nearest neighbour qubits can perform a 2 qubit gate. The mapper
uses Swap gates in order to move qubits next to each other.
*/
import assert from &apos;assert&apos;
import math from &apos;mathjs&apos;
import {permutations} from &apos;itertools&apos;
import BasicMapperEngine from &apos;./basicmapper&apos;;
import {return_swap_depth} from &apos;./linearmapper&apos;
import NativeImpl from &apos;../backends/simulators/cppsim&apos;
import {
  arrayFromRange, len, randomSample, setDifference, setEqual, setFromRange
} from &apos;../libs/polyfill&apos;;
import LinearMapper from &apos;./linearmapper&apos;;
import {
  AllocateQubitGate, DeallocateQubitGate, FlushGate, Swap
} from &apos;../ops&apos;;
import {tuple} from &apos;../libs/util&apos;;
import Command from &apos;../ops/command&apos;;
import {BasicQubit} from &apos;../types/qubit&apos;;
import {LogicalQubitIDTag} from &apos;../meta&apos;;

/**
 * @class GridMapper
 * @desc
Mapper to a 2-D grid graph.

    Mapped qubits on the grid are numbered in row-major order. E.g. for
3 rows and 2 columns:

    0 - 1
    |   |
    2 - 3
    |   |
    4 - 5

The numbers are the mapped qubit ids. The backend might number
the qubits on the grid differently (e.g. not row-major), we call these
backend qubit ids. If the backend qubit ids are not row-major, one can
pass a dictionary translating from our row-major mapped ids to these
backend ids.

    Note: The algorithm sorts twice inside each column and once inside each
row.

    Attributes:
current_mapping:  Stores the mapping: key is logical qubit id, value
is backend qubit id.
storage(int): Number of gate it caches before mapping.
num_rows(int): Number of rows in the grid
num_columns(int): Number of columns in the grid
num_qubits(int): num_rows x num_columns = number of qubits
num_mappings (int): Number of times the mapper changed the mapping
depth_of_swaps (dict): Key are circuit depth of swaps, value is the
number of such mappings which have been
applied
num_of_swaps_per_mapping (dict): Key are the number of swaps per
mapping, value is the number of such
mappings which have been applied
 */
export default class GridMapper extends BasicMapperEngine {
  /**
   * @constructor
  Initialize a GridMapper compiler engine.

    @param {{num_rows: number, num_columns: number, mapped_ids_to_backend_ids: Object, storage: number, optimization_function: function, num_optimization_steps: number}} args
      num_rows(int): Number of rows in the grid
      num_columns(int): Number of columns in the grid.
      mapped_ids_to_backend_ids(dict): Stores a mapping from mapped ids which are 0,...,this.num_qubits-1
      in row-major order on the grid to the corresponding qubit ids of the backend.
      Key: mapped id. Value: corresponding backend id. Default is None
      which means backend ids are identical to mapped ids.
      storage: Number of gates to temporarily store
      optimization_function: Function which takes a list of swaps and returns a cost value. Mapper chooses a
        permutation which minimizes this cost. Default optimizes for circuit depth.
      num_optimization_steps(int): Number of different permutations to of the matching to try and minimize the cost.
    @throws {Error} if incorrect `mapped_ids_to_backend_ids` parameter
   */
  constructor(args) {
    super()
    const {
      num_rows, num_columns, mapped_ids_to_backend_ids,
      storage = 1000,
      optimization_function = x =&gt; return_swap_depth(x),
      num_optimization_steps = 50
    } = args


    this.num_rows = num_rows
    this.num_columns = num_columns
    this.num_qubits = num_rows * num_columns
    // Internally we use the mapped ids until sending a command.
    // Before sending we use this map to translate to backend ids:
    this._mapped_ids_to_backend_ids = mapped_ids_to_backend_ids
    if (typeof this._mapped_ids_to_backend_ids === &apos;undefined&apos; || this._mapped_ids_to_backend_ids === null) {
      this._mapped_ids_to_backend_ids = {}
      for (let i = 0; i &lt; this.num_qubits; ++i) {
        this._mapped_ids_to_backend_ids[i] = i
      }
    }

    const f1 = setEqual(new Set(Object.keys(this._mapped_ids_to_backend_ids).map(k =&gt; parseInt(k, 10))), setFromRange(this.num_qubits))
    const f2 = new Set(Object.values(this._mapped_ids_to_backend_ids)).size === this.num_qubits
    if (!f1 || !f2) {
      throw new Error(&apos;Incorrect mapped_ids_to_backend_ids parameter&apos;)
    }
    this._backend_ids_to_mapped_ids = {}

    Object.keys(this._mapped_ids_to_backend_ids).forEach((mapped_id) =&gt; {
      const backend_id = this._mapped_ids_to_backend_ids[mapped_id]
      this._backend_ids_to_mapped_ids[backend_id] = mapped_id
    })
    // As we use internally the mapped ids which are in row-major order,
    // we have an internal current mapping which maps from logical ids to
    // these mapped ids:
    this._current_row_major_mapping = Object.assign({}, this._currentMapping)
    this.storage = storage
    this.optimization_function = optimization_function
    this.num_optimization_steps = num_optimization_steps
    // Randomness to pick permutations if there are too many.
    // This creates an own instance of Random in order to not influence
    // the bound methods of the random module which might be used in other
    // places.
    // TODO
    // this._rng = random.Random(11)
    // Storing commands
    this._stored_commands = []
    // Logical qubit ids for which the Allocate gate has already been
    // processed and sent to the next engine but which are not yet
    // deallocated:
    this._currently_allocated_ids = new Set()
    // Change between 2D and 1D mappings (2D is a snake like 1D chain)
    // Note it translates to our mapped ids in row major order and not
    // backend ids which might be different.
    this._map_2d_to_1d = {}
    this._map_1d_to_2d = {}
    for (let row_index = 0; row_index &lt; this.num_rows; ++row_index) {
      for (let column_index = 0; column_index &lt; this.num_columns; ++column_index) {
        if (row_index % 2 === 0) {
          const mapped_id = row_index * this.num_columns + column_index
          this._map_2d_to_1d[mapped_id] = mapped_id
          this._map_1d_to_2d[mapped_id] = mapped_id
        } else {
          const mapped_id_2d = row_index * this.num_columns + column_index
          const mapped_id_1d = ((row_index + 1) * this.num_columns - column_index - 1)
          this._map_2d_to_1d[mapped_id_2d] = mapped_id_1d
          this._map_1d_to_2d[mapped_id_1d] = mapped_id_2d
        }
      }
    }

    // Statistics:
    this.num_mappings = 0
    this.depth_of_swaps = {}
    this.num_of_swaps_per_mapping = {}
  }

  get currentMapping() {
    return super.currentMapping
  }

  set currentMapping(newMapping) {
    this._currentMapping = newMapping
    if (typeof newMapping === &apos;undefined&apos; || newMapping === null) {
      this._current_row_major_mapping = newMapping
    } else {
      this._current_row_major_mapping = {}

      Object.keys(newMapping).forEach((logical_id) =&gt; {
        const backend_id = newMapping[logical_id]
        const value = this._backend_ids_to_mapped_ids[backend_id]
        this._current_row_major_mapping[logical_id] = parseInt(value, 10)
      })
    }
  }

  // Only allows 1 || two qubit gates.
  isAvailable(cmd) {
    let num_qubits = 0
    cmd.allQubits.forEach(qureg =&gt; num_qubits += qureg.length)
    return num_qubits &lt;= 2
  }

  /**
  Returns a new mapping of the qubits.

    It goes through this._saved_commands and tries to find a
mapping to apply these gates on a first come first served basis.
    It reuses the function of a 1D mapper and creates a mapping for a
  1D linear chain and then wraps it like a snake onto the square grid.

    One might create better mappings by specializing this function for a
  square grid.

    @return {Object} A new mapping as a dict. key is logical qubit id, value is mapped id
   */
  returnNewMapping() {
    // Change old mapping to 1D in order to use LinearChain heuristic
    let old_mapping_1d
    if (this._current_row_major_mapping) {
      old_mapping_1d = {}
      Object.keys(this._current_row_major_mapping).forEach((logical_id) =&gt; {
        const mapped_id = this._current_row_major_mapping[logical_id]
        old_mapping_1d[logical_id] = this._map_2d_to_1d[mapped_id]
      })
    } else {
      old_mapping_1d = this._current_row_major_mapping
    }

    const new_mapping_1d = LinearMapper.returnNewMapping(
      this.num_qubits,
      false,
      this._currently_allocated_ids,
      this._stored_commands,
      old_mapping_1d
    )

    const new_mapping_2d = {}
    Object.keys(new_mapping_1d).forEach((logical_id) =&gt; {
      const mapped_id = new_mapping_1d[logical_id]
      new_mapping_2d[logical_id] = this._map_1d_to_2d[mapped_id]
    })

    return new_mapping_2d
  }

  // If swapped (inplace), then return swap operation
  // so that key(element0) &lt; key(element1)
  _compareAndSwap(element0, element1, key) {
    if (key(element0) &gt; key(element1)) {
      const mapped_id0 = (element0.current_column + element0.current_row * this.num_columns)
      const mapped_id1 = (element1.current_column + element1.current_row * this.num_columns)
      const swap_operation = [mapped_id0, mapped_id1]
      // swap elements but update also current position:
      const tmp_0 = element0.final_row
      const tmp_1 = element0.final_column
      const tmp_2 = element0.row_after_step_1
      element0.final_row = element1.final_row
      element0.final_column = element1.final_column
      element0.row_after_step_1 = element1.row_after_step_1
      element1.final_row = tmp_0
      element1.final_column = tmp_1
      element1.row_after_step_1 = tmp_2
      return swap_operation
    }
    return undefined
  }

  _sortWithinRows(final_positions, key) {
    const swap_operations = []
    for (let row = 0; row &lt; this.num_rows; ++row) {
      let finished_sorting = false
      while (!finished_sorting) {
        finished_sorting = true
        for (let column = 1; column &lt; this.num_columns - 1; column += 2) {
          const element0 = final_positions[row][column]
          const element1 = final_positions[row][column + 1]
          const swap = this._compareAndSwap(element0, element1, key)
          if (typeof swap !== &apos;undefined&apos;) {
            finished_sorting = false
            swap_operations.push(swap)
          }
        }

        for (let column = 0; column &lt; this.num_columns - 1; column += 2) {
          const element0 = final_positions[row][column]
          const element1 = final_positions[row][column + 1]
          const swap = this._compareAndSwap(element0, element1, key)
          if (typeof swap !== &apos;undefined&apos;) {
            finished_sorting = false
            swap_operations.push(swap)
          }
        }
      }
    }
    return swap_operations
  }

  _sortWithinColumns(final_positions, key) {
    const swap_operations = []
    for (let column = 0; column &lt; this.num_columns; ++column) {
      let finished_sorting = false
      while (!finished_sorting) {
        finished_sorting = true
        for (let row = 1; row &lt; this.num_rows - 1; row += 2) {
          const element0 = final_positions[row][column]
          const element1 = final_positions[row + 1][column]
          const swap = this._compareAndSwap(element0, element1, key)
          if (typeof swap !== &apos;undefined&apos;) {
            finished_sorting = false
            swap_operations.push(swap)
          }
        }

        for (let row = 0; row &lt; this.num_rows - 1; row += 2) {
          const element0 = final_positions[row][column]
          const element1 = final_positions[row + 1][column]
          const swap = this._compareAndSwap(element0, element1, key)
          if (typeof swap !== &apos;undefined&apos;) {
            finished_sorting = false
            swap_operations.push(swap)
          }
        }
      }
    }
    return swap_operations
  }

  /**
  Creates a new mapping and executes possible gates.

    It first allocates all 0, ..., this.num_qubits-1 mapped qubit ids, if
    they are not already used because we might need them all for the
  swaps. Then it creates a new map, swaps all the qubits to the new map,
    executes all possible gates, and finally deallocates mapped qubit ids
which don&apos;t store any information.
   */
  _run() {
    const num_of_stored_commands_before = len(this._stored_commands)
    if (!this._currentMapping) {
      this.currentMapping = {}
    } else {
      this._sendPossibleCommands()
      if (len(this._stored_commands) === 0) {
        return
      }
    }

    const new_row_major_mapping = this.returnNewMapping()
    // Find permutation of matchings with lowest cost
    let swaps
    let lowest_cost
    const matchings_numbers = arrayFromRange(this.num_rows)
    const ps = []
    if (this.num_optimization_steps &lt;= math.factorial(this.num_rows)) {
      for (const looper of permutations(matchings_numbers, this.num_rows)) {
        ps.push(looper)
      }
    } else {
      for (let i = 0; i &lt; this.num_optimization_steps; ++i) {
        ps.push(randomSample(matchings_numbers, this.num_rows))
      }
    }

    ps.forEach((permutation) =&gt; {
      const trial_swaps = this.returnSwaps(
        this._current_row_major_mapping,
        new_row_major_mapping,
        permutation
      )
      if (typeof swaps === &apos;undefined&apos;) {
        swaps = trial_swaps
        lowest_cost = this.optimization_function(trial_swaps)
      } else if (lowest_cost &gt; this.optimization_function(trial_swaps)) {
        swaps = trial_swaps
        lowest_cost = this.optimization_function(trial_swaps)
      }
    })
    if (swaps.length &gt; 0) { // first mapping requires no swaps
      // Allocate all mapped qubit ids (which are not already allocated,
      // i.e., contained in this._currently_allocated_ids)
      let mapped_ids_used = new Set()
      for (const logical_id of this._currently_allocated_ids) {
        mapped_ids_used.add(this._current_row_major_mapping[logical_id])
      }
      const not_allocated_ids = setDifference(setFromRange(this.num_qubits), mapped_ids_used)
      for (const mapped_id of not_allocated_ids) {
        const qb = new BasicQubit(this, this._mapped_ids_to_backend_ids[mapped_id])
        const cmd = new Command(this, new AllocateQubitGate(), tuple([qb]))
        this.send([cmd])
      }


      // Send swap operations to arrive at new_mapping:
      swaps.forEach(([qubit_id0, qubit_id1]) =&gt; {
        const q0 = new BasicQubit(this, this._mapped_ids_to_backend_ids[qubit_id0])
        const q1 = new BasicQubit(this, this._mapped_ids_to_backend_ids[qubit_id1])
        const cmd = new Command(this, Swap, tuple([q0], [q1]))
        this.send([cmd])
      })
      // Register statistics:
      this.num_mappings += 1
      const depth = return_swap_depth(swaps)
      if (!(depth in this.depth_of_swaps)) {
        this.depth_of_swaps[depth] = 1
      } else {
        this.depth_of_swaps[depth] += 1
      }
      if (!(len(swaps) in this.num_of_swaps_per_mapping)) {
        this.num_of_swaps_per_mapping[len(swaps)] = 1
      } else {
        this.num_of_swaps_per_mapping[len(swaps)] += 1
      }
      // Deallocate all previously mapped ids which we only needed for the
      // swaps:
      mapped_ids_used = new Set()
      for (const logical_id of this._currently_allocated_ids) {
        mapped_ids_used.add(new_row_major_mapping[logical_id])
      }
      const not_needed_anymore = setDifference(setFromRange(this.num_qubits), mapped_ids_used)
      for (const mapped_id of not_needed_anymore) {
        const qb = new BasicQubit(this, this._mapped_ids_to_backend_ids[mapped_id])
        const cmd = new Command(this, new DeallocateQubitGate(), tuple([qb]))
        this.send([cmd])
      }
    }

    // Change to new map:
    this._current_row_major_mapping = new_row_major_mapping
    const new_mapping = {}
    Object.keys(new_row_major_mapping).forEach((logical_id) =&gt; {
      const mapped_id = new_row_major_mapping[logical_id]
      new_mapping[logical_id] = this._mapped_ids_to_backend_ids[mapped_id]
    })

    this.currentMapping = new_mapping
    // Send possible gates
    this._sendPossibleCommands()
    // Check that mapper actually made progress
    if (len(this._stored_commands) === num_of_stored_commands_before) {
      throw new Error(&apos;Mapper is potentially in an infinite loop. &apos;
          + &apos;It is likely that the algorithm requires &apos;
          + &apos;too many qubits. Increase the number of &apos;
          + &apos;qubits for this mapper.&apos;)
    }
  }

  /**
  Sends the stored commands possible without changing the mapping.

    Note: this._current_row_major_mapping (hence also this.currentMapping) must exist already
   */
  _sendPossibleCommands() {
    const active_ids = new Set(Array.from(this._currently_allocated_ids).map(k =&gt; parseInt(k, 10)))
    Object.keys(this._current_row_major_mapping).forEach(logical_id =&gt; active_ids.add(parseInt(logical_id, 10)))

    let new_stored_commands = []
    for (let i = 0; i &lt; this._stored_commands.length; ++i) {
      const cmd = this._stored_commands[i]
      if (len(active_ids) === 0) {
        new_stored_commands = new_stored_commands.concat(this._stored_commands.slice(i))
        break
      }
      if (cmd.gate instanceof AllocateQubitGate) {
        const qid = cmd.qubits[0][0].id
        if (qid in this._current_row_major_mapping) {
          this._currently_allocated_ids.add(qid)
          const mapped_id = this._current_row_major_mapping[qid]
          const qb = new BasicQubit(this, this._mapped_ids_to_backend_ids[mapped_id])
          const new_cmd = new Command(this, new AllocateQubitGate(), tuple([qb]), [], [new LogicalQubitIDTag(qid)])
          this.send([new_cmd])
        } else {
          new_stored_commands.push(cmd)
        }
      } else if (cmd.gate instanceof DeallocateQubitGate) {
        const qid = cmd.qubits[0][0].id
        if (active_ids.has(qid)) {
          const mapped_id = this._current_row_major_mapping[qid]
          const qb = new BasicQubit(this, this._mapped_ids_to_backend_ids[mapped_id])
          const new_cmd = new Command(this, new DeallocateQubitGate(), tuple([qb]), [], [new LogicalQubitIDTag(qid)])
          this._currently_allocated_ids.delete(qid)
          active_ids.delete(qid)
          delete this._current_row_major_mapping[qid]
          delete this._currentMapping[qid]
          this.send([new_cmd])
        } else {
          new_stored_commands.push(cmd)
        }
      } else {
        let send_gate = true
        const mapped_ids = new Set()

        for (let k = 0; k &lt; cmd.allQubits.length; ++k) {
          const qureg = cmd.allQubits[k]
          for (let j = 0; j &lt; qureg.length; ++j) {
            const qubit = qureg[j]
            if (!active_ids.has(qubit.id)) {
              send_gate = false
              break
            }
            mapped_ids.add(this._current_row_major_mapping[qubit.id])
          }
        }


        // Check that mapped ids are nearest neighbour on 2D grid
        if (len(mapped_ids) === 2) {
          const [qb0, qb1] = Array.from(mapped_ids).sort((a, b) =&gt; a - b)
          send_gate = false
          if (qb1 - qb0 === this.num_columns) {
            send_gate = true
          } else if (qb1 - qb0 === 1 &amp;&amp; (qb1 % this.num_columns !== 0)) {
            send_gate = true
          }
        }
        if (send_gate) {
          // Note: This sends the cmd correctly with the backend ids
          //       as it looks up the mapping in this.currentMapping
          //       and not our internal mapping
          //       this._current_row_major_mapping
          this.sendCMDWithMappedIDs(cmd)
        } else {
          cmd.allQubits.forEach(qureg =&gt; qureg.forEach(qubit =&gt; active_ids.delete(qubit.id)))
          new_stored_commands.push(cmd)
        }
      }
    }

    this._stored_commands = new_stored_commands
  }

  /**
  Receives a command list and, for each command, stores it until
  we do a mapping (FlushGate || Cache of stored commands is full).
   @param {Command[]} command_list  list of commands to receive.
  */
  receive(command_list) {
    command_list.forEach((cmd) =&gt; {
      if (cmd.gate instanceof FlushGate) {
        while (this._stored_commands.length &gt; 0) {
          this._run()
        }
        this.send([cmd])
      } else {
        this._stored_commands.push(cmd)
      }

      if (this._stored_commands.length &gt;= this.storage) {
        this._run()
      }
    })
  }

  /**
  Returns the swap operation to change mapping

    @param {Object} old_mapping dict keys are logical ids and values are mapped qubit ids
    @param {Object} new_mapping dict keys are logical ids and values are mapped qubit ids
    @param {Array.&lt;number[]&gt;} permutation list of int from 0, 1, ..., this.num_rows-1. It is
      used to permute the found perfect matchings. Default is None which keeps the original order.
    @return {Array.&lt;number[]&gt;} List of tuples. Each tuple is a swap operation which needs to be
      applied. Tuple contains the two mapped qubit ids for the Swap.
   */
  returnSwaps(old_mapping, new_mapping, permutation) {
    if (typeof permutation === &apos;undefined&apos;) {
      permutation = arrayFromRange(this.num_rows)
    }
    let swap_operations = []

    class Position {
      constructor(current_row, current_column, final_row, final_column, row_after_step_1) {
        this.current_row = current_row
        this.current_column = current_column
        this.final_row = final_row
        this.final_column = final_column
        this.row_after_step_1 = row_after_step_1
      }
    }
    // final_positions contains info containers
    // final_position[i][j] contains info container with
    // current_row == i and current_column == j
    const final_positions = new Array(this.num_rows)
    for (let i = 0; i &lt; this.num_rows; ++i) {
      final_positions[i] = new Array(this.num_columns)
    }

    // move qubits which are in both mappings
    const used_mapped_ids = new Set()

    Object.keys(old_mapping).forEach((logical_id) =&gt; {
      if (logical_id in new_mapping) {
        used_mapped_ids.add(new_mapping[logical_id])
        const old_column = old_mapping[logical_id] % this.num_columns
        const old_row = Math.floor(old_mapping[logical_id] / this.num_columns)
        const new_column = new_mapping[logical_id] % this.num_columns
        const new_row = Math.floor(new_mapping[logical_id] / this.num_columns)
        const info_container = new Position(old_row,
          old_column,
          new_row,
          new_column)
        final_positions[old_row][old_column] = info_container
      }
    })
    // exchange all remaining None with the not yet used mapped ids
    const all_ids = setFromRange(this.num_qubits)
    let not_used_mapped_ids = Array.from(setDifference(all_ids, used_mapped_ids))
    not_used_mapped_ids = not_used_mapped_ids.sort((a, b) =&gt; b - a)

    for (let row = 0; row &lt; this.num_rows; ++row) {
      for (let column = 0; column &lt; this.num_columns; ++column) {
        if (typeof final_positions[row][column] === &apos;undefined&apos;) {
          const mapped_id = not_used_mapped_ids.pop()
          const new_column = mapped_id % this.num_columns
          const new_row = Math.floor(mapped_id / this.num_columns)
          const info_container = new Position(row, column, new_row, new_column)
          final_positions[row][column] = info_container
        }
      }
    }

    assert(len(not_used_mapped_ids) === 0)
    const positions = []
    final_positions.forEach(row =&gt; positions.push(row.map(item =&gt; item.final_column)))
    const matchings = NativeImpl.returnNewSwap(this.num_rows, this.num_columns, positions)
    const offset = this.num_columns
    // permute the matchings
    const tmp = matchings.map(looper =&gt; Object.assign({}, looper))
    for (let i = 0; i &lt; this.num_rows; ++i) {
      matchings[i] = tmp[permutation[i]]
    }
    // Assign row_after_step_1
    for (let column = 0; column &lt; this.num_columns; ++column) {
      for (let row_after_step_1 = 0; row_after_step_1 &lt; this.num_rows; ++row_after_step_1) {
        const dest_column = matchings[row_after_step_1][column] - offset
        let best_element
        for (let row = 0; row &lt; this.num_rows; ++row) {
          const element = final_positions[row][column]
          if (typeof element.row_after_step_1 !== &apos;undefined&apos;) {
            continue
          } else if (element.final_column === dest_column) {
            if (typeof best_element === &apos;undefined&apos;) {
              best_element = element
            } else if (best_element.final_row &gt; element.final_row) {
              best_element = element
            }
          }
        }
        best_element.row_after_step_1 = row_after_step_1
      }
    }

    // 2. Sort inside all the rows
    let swaps = this._sortWithinColumns(final_positions, x =&gt; x.row_after_step_1)
    swap_operations = swap_operations.concat(swaps)
    // 3. Sort inside all the columns
    swaps = this._sortWithinRows(final_positions, x =&gt; x.final_column)
    swap_operations = swap_operations.concat(swaps)
    // 4. Sort inside all the rows
    swaps = this._sortWithinColumns(final_positions, x =&gt; x.final_row)
    swap_operations = swap_operations.concat(swaps)
    return swap_operations
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
